---
import { getCollection } from "astro:content";
import { BlogCard } from "../cards/BlogCard";

const entries = await getCollection("blog");

// sort by publishDate (newest first) and take latest 3
const sorted = entries.slice().sort((a, b) => {
    const aDate = a.data?.publishDate
        ? new Date(a.data.publishDate).getTime()
        : 0;
    const bDate = b.data?.publishDate
        ? new Date(b.data.publishDate).getTime()
        : 0;
    return bDate - aDate;
});
const latestEntries = sorted.slice(0, 3);

const blogsFromContent = latestEntries.map((entry) => {
    const d = entry.data as any;

    const photo = typeof d.cover === "string" ? d.cover : d.cover?.src ?? "";
    const tags = Array.isArray(d.tags) ? d.tags : d.tags ? [d.tags] : [];

    const content =
        typeof d.body === "string"
            ? d.body
            : typeof entry.body === "string"
              ? entry.body
              : "";

    return {
        id: String(entry.slug),
        title: d.title ?? "",
        photo,
        tags,
        content,
        href: `/blog/${entry.slug}`,
        publishDate: d.publishDate ?? null,
    };
});

// layout helpers to keep 1 or 2 cards centered + limited width
const count = blogsFromContent.length;
const wrapperMaxClass =
    count === 1 ? "max-w-xl" : count === 2 ? "max-w-3xl" : "max-w-full";
const gridColsClass =
    count >= 3
        ? "grid-cols-[repeat(auto-fit,minmax(260px,1fr))]"
        : `grid-cols-[repeat(${Math.max(1, count)},minmax(260px,360px))]`;
const justifyClass = count < 3 ? "justify-center" : "";
---

<section id="blog" class="container mx-auto px-4 py-16 sm:px-6 lg:px-8">
    <div class="text-center">
        <h2
            class="text-3xl font-bold tracking-tight font-italiana text-[#102227] sm:text-4xl"
        >
            From Our Blog
        </h2>
        <p class="mt-4 text-lg leading-8 text-[#102227]/80">
            Stay updated with the latest trends and insights in the real estate
            market.
        </p>
    </div>

    <div class={`mt-12 ${wrapperMaxClass} mx-auto`}>
        <div class={`grid gap-8 ${gridColsClass} ${justifyClass}`}>
            {
                blogsFromContent.map((blog) => (
                    <BlogCard
                        title={blog.title}
                        photo={blog.photo}
                        tags={blog.tags}
                        content={blog.content}
                        href={blog.href}
                    />
                ))
            }
        </div>
    </div>

    <div class="mt-12 text-center">
        <a
            class="inline-block rounded-lg bg-[#94792f] px-8 py-3 text-base font-semibold text-white shadow-md hover:bg-[#94792f]/90 focus:outline-none focus:ring-2 focus:ring-[#94792f] focus:ring-offset-2 focus:ring-offset-[#ffffff]"
            href="/blog"
            target="_blank"
        >
            Browse All Posts
        </a>
    </div>
</section>
