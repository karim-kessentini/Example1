---
import Footer from "../../layouts/Footer.astro";
import SimpleNavbar from "../../layouts/SimpleNavbar.astro";
import { getEntryBySlug, getCollection } from "astro:content";
import MarkdownIt from "markdown-it";

export async function getStaticPaths() {
    const entries = await getCollection("blog");
    return entries.map((entry) => ({
        params: { slug: String(entry.slug) },
    }));
}

const { slug } = Astro.params;
const entry = await getEntryBySlug("blog", String(slug));

if (!entry) {
    throw new Error(`Blog post not found: ${slug}`);
}

const d = entry.data as any;

// Normalize cover image
const photo = typeof d.cover === "string" ? d.cover : d.cover?.src ?? "";

// Normalize tags
const tags = Array.isArray(d.tags) ? d.tags : d.tags ? [d.tags] : [];

// Prefer frontmatter `body`, fallback to entry.body (markdown content)
const rawContent =
    typeof d.body === "string"
        ? d.body
        : typeof entry.body === "string"
          ? entry.body
          : entry.body
            ? String(entry.body)
            : "";

// Render markdown to HTML using markdown-it
const md = new MarkdownIt({ html: true });
const content = md.render(rawContent || "");

// Format publish date
const publishDate = d.publishDate
    ? new Date(d.publishDate).toLocaleDateString(undefined, {
          year: "numeric",
          month: "long",
          day: "numeric",
      })
    : "";
---

<html lang="en" class="scroll-smooth">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.png" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <title>{d.title ?? "Blog Post"}</title>
        <link rel="stylesheet" href="/style/custom.css" />
    </head>
    <body class="overflow-hidden overflow-y-auto bg-body">
        <SimpleNavbar />
        <main class="mx-auto w-full max-w-4xl px-6 py-12">
            <div class="space-y-12">
                <article>
                    <div class="mb-8">
                        <div
                            class="flex items-center gap-2 text-sm text-gray-500 mb-2"
                        >
                            <a class="hover:text-[#aa8518]" href="/blog">Blog</a
                            >
                            <span>/</span>
                            <span class="text-gray-800">{d.title}</span>
                        </div>
                        <h1
                            class="text-4xl md:text-5xl font-bold tracking-tight text-[#1b3942]"
                        >
                            {d.title}
                        </h1>
                        <p class="mt-3 text-sm text-gray-500">
                            {publishDate}
                        </p>
                    </div>

                    {
                        photo ? (
                            <div class="mb-4 overflow-hidden rounded-lg">
                                <img
                                    alt={d.title ?? "Cover"}
                                    class="w-full h-auto object-cover aspect-[16/9]"
                                    src={photo}
                                />
                            </div>
                        ) : null
                    }

                    <div class="mb-5">
                        {
                            tags.length > 0 ? (
                                <span class="inline-flex items-center rounded-3xl bg-[#94792f] px-2 py-1 text-xs font-medium text-white inset-ring inset-ring-gray-400/20">
                                    {tags.join(", ")}
                                </span>
                            ) : null
                        }
                    </div>

                    <div
                        class="prose prose-lg max-w-none space-y-6 text-gray-700"
                        set:html={content}
                    />
                </article>
            </div>
        </main>
        <Footer />
    </body>
</html>
